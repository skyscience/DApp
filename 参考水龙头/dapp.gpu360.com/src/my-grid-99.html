<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
--><link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../bower_components/promise-polyfill/promise-polyfill-lite.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-input/iron-input.html">
<link rel="import" href="../bower_components/sortable-list/index.html">
<!-- <link rel="import" href="../polymer/lib/elements/dom-repeat.html"> -->
<!-- <script src="../neb.js/index.js"></script> -->
<dom-module id="grid-99">
    <template>
        <style include="shared-styles">
            :host {
                display: block;

                padding: 10px;
            }

            body {
                font-family: sans-serif;
            }

            .item {
                background:	#FFFAFA;
                display: inline-block;
                float: left;
                height: 150px;
                margin: 10px 10px 0 0;
                text-align: center;
                vertical-align: top;
                width: 150px;
            }

            .item img {
                height: 90%;
                width: 90%;
            }
        </style>
        <custom-style>
            <style is="custom-style">
                .flex-equal-justified {
                    @apply --layout-horizontal;
                    @apply --layout-justified;
                    @apply --layout-center;
                }
            </style>
        </custom-style>
        <div class="card">
            <h1>99 Grids</h1>
            <p>There are a total of 99 grids, each with 1000 NAS. You can record a picture and a piece of text here forever. </p>
            
        </div>
        <iron-ajax id="ajaxCall" url="https://mainnet.nebulas.io/v1/user/call" method="post" body="[[body]]" content-type="application/json" handle-as="json" on-response="_handleResponse">
        </iron-ajax>
        
        <div class="card container flex-equal-justified">
            <!--<sortable-list sortable=".item">-->
            <sortable-list on-sort-finish="_onSortFinish" dragging="{{dragging}}">
                <dom-repeat id="domRepeat">
                    <template>
                        <div class="item card container">
                            <img src="http://dapp.gpu360.com/src/{{item.1}}">
                            <br>
                            <span style="font-size:auto" align="center">{{item.0}}</span>
                        </div>
                    </template>
                </dom-repeat>
            </sortable-list>
        </div>

        <div class="card container flex-equal-justified">
            <iron-input auto-validate="">
                <input id="inputName" pattern="\d{3}" placeholder="Insert your Company name" maxlength="8">
                <input id="url" pattern="\d{3}" placeholder="Insert your logo image url" maxlength="2083">
            </iron-input>
            <paper-button raised="" on-tap="_handleAdd">Apply for a place </paper-button>
        </div>
    </template>
    <script>function _instanceof(left, right) { if (right != null && typeof Symbol !== "undefined" && right[Symbol.hasInstance]) { return right[Symbol.hasInstance](left); } else { return left instanceof right; } }

function _typeof(obj) { if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

function _classCallCheck(instance, Constructor) { if (!_instanceof(instance, Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (call && (_typeof(call) === "object" || typeof call === "function")) { return call; } return _assertThisInitialized(self); }

function _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return self; }

function _get(target, property, receiver) { if (typeof Reflect !== "undefined" && Reflect.get) { _get = Reflect.get; } else { _get = function _get(target, property, receiver) { var base = _superPropBase(target, property); if (!base) return; var desc = Object.getOwnPropertyDescriptor(base, property); if (desc.get) { return desc.get.call(receiver); } return desc.value; }; } return _get(target, property, receiver || target); }

function _superPropBase(object, property) { while (!Object.prototype.hasOwnProperty.call(object, property)) { object = _getPrototypeOf(object); if (object === null) break; } return object; }

function _getPrototypeOf(o) { _getPrototypeOf = Object.getPrototypeOf || function _getPrototypeOf(o) { return o.__proto__; }; return _getPrototypeOf(o); }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function"); } _setPrototypeOf(subClass.prototype, superClass && superClass.prototype); if (superClass) _setPrototypeOf(subClass, superClass); }

function _setPrototypeOf(o, p) { _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) { o.__proto__ = p; return o; }; return _setPrototypeOf(o, p); }

// var domRepeat = document.querySelector('#domRepeat');
var Grid =
/*#__PURE__*/
function (_Polymer$Element) {
  _inherits(Grid, _Polymer$Element);

  _createClass(Grid, null, [{
    key: "is",
    get: function get() {
      return 'grid-99';
    }
  }]);

  function Grid() {
    var _this;

    _classCallCheck(this, Grid);

    _this = _possibleConstructorReturn(this, (Grid.__proto__ || Object.getPrototypeOf(Grid)).call(this));
    _this.to = "n1q4swrRLHh2iHaosoiuMYn69YwEnoVTPGQ";
    _this.value = 1000000000000000000000;
    _this.name = [];
    return _this;
  }

  _createClass(Grid, [{
    key: "_handleResponse",
    value: function _handleResponse(e, request) {
      this.result = JSON.parse(request.response.result.result);
      var arr = [];
      var map = [];

      for (var p in this.result) {
        //遍历json对象的每个key/value对,p为key
        map = [];
        map[0] = p;
        map[1] = this.result[p];

        if (arr.length == 0) {
          arr[0] = map;
        } else {
          arr[arr.length] = map;
        }
      }

      this.$.domRepeat.items = arr;
      console.log("数组:" + this.$.domRepeat.items); //console.log("响应"+result)
    }
  }, {
    key: "_slice",
    value: function _slice(str, s, e) {
      //console.log("拆分:"+str.slice(s,e))
      return str.slice(s, e);
    }
  }, {
    key: "_send",
    value: function _send(name, value, url) {
      if (!name) {
        return;
      }

      window.postMessage({
        "target": "contentscript",
        "data": {
          "to": this.to,
          "value": value,
          "contract": {
            //"contract" is a parameter used to deploy a contract or call a smart contract function
            "function": "apply",
            "args": "[\"" + name.trim() + "\",\"" + url.trim() + "\"]"
          }
        },
        "method": "neb_sendTransaction"
      }, "*");
    }
  }, {
    key: "_handleAdd",
    value: function _handleAdd(event) {
      this._send(this.$.inputName.value, this.value, this.$.url.value);

      this.$.inputName.value = "";
      this.$.url.value = "";
    }
  }, {
    key: "plusone",
    value: function plusone(num) {
      return num + 1;
    }
  }, {
    key: "ready",
    value: function ready() {
      var _this2 = this;

      _get(Grid.prototype.__proto__ || Object.getPrototypeOf(Grid.prototype), "ready", this).call(this);

      window.addEventListener('message', function (e) {
        console.log("message received, msg.data: " + JSON.stringify(e.data));

        if (!!e.data.data.txhash) {
          console.log("Transaction hash:\n" + JSON.stringify(e.data.data.txhash, null, '\t'));
        }
      });
      this.body = {
        "from": "n1cS26LrgGEUazvaGHGW2Nr6AMPBQ52NoC3",
        "to": this.to,
        "value": "0",
        "nonce": 17,
        "gasPrice": "1000000",
        "gasLimit": "2000000",
        "contract": {
          "function": "info",
          "args": ""
        }
      };
      this.$.ajaxCall.generateRequest();
      setInterval(function () {
        _this2.$.ajaxCall.generateRequest();
      }, 5 * 1000);
    }
  }, {
    key: "_toArray",
    value: function _toArray(obj) {
      var arr = Object.keys(obj).map(function (key) {
        return {
          name: key,
          value: obj[key]
        };
      });
      arr = arr.sort(function (a, b) {
        return b.value - a.value;
      });
      return arr;
    }
  }]);

  return Grid;
}(Polymer.Element);

window.customElements.define(Grid.is, Grid);</script>
</dom-module>
